!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(n="undefined"!=typeof globalThis?globalThis:n||self,function(){var t=n.focusNoJutsu,r=n.focusNoJutsu=e();r.noConflict=function(){return n.focusNoJutsu=t,r}}())}(this,(function(){"use strict";function n(n,e){for(var t=0;t<e.length;t++){var r=e[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,(u=r.key,o=void 0,"symbol"==typeof(o=function(n,e){if("object"!=typeof n||null===n)return n;var t=n[Symbol.toPrimitive];if(void 0!==t){var r=t.call(n,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(n)}(u,"string"))?o:String(o)),r)}var u,o}function e(){return e=Object.assign?Object.assign.bind():function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r])}return n},e.apply(this,arguments)}var t=function(n){return Object.prototype.toString.call(n)},r=function(n){return"[object Object]"===t(n)},u=function(n){return"[object Function]"===t(n)},o=function(){return document.activeElement},i=function(n){return"string"==typeof n?(e=n,document.querySelector(e)):n;var e},c=function(n){setTimeout(n,0)},l=function(n){return"Enter"===n.key||13===n.keyCode},a=function(n){return"Escape"===n.key||"Esc"===n.key||27===n.keyCode},f=function(n){return"Tab"===n.key||9===n.keyCode},s=function(n){return f(n)&&!n.shiftKey},v=function(n){return f(n)&&n.shiftKey},d=function(n){var e;n.focus(),(e=n).tagName&&"input"===e.tagName.toLowerCase()&&"function"==typeof e.select&&n.select()},p=function(n){null==n?c((function(){return n&&d(n)})):d(n)},h=function(n,e,t,r){var u,o=e.map((function(n){return i(n)})).filter((function(n){return null!=n})),c=o[0],l=o.slice(-1)[0],a=null!==(u=i(n))&&void 0!==u?u:function(n,e){if(null==n||null==e)return null;if(n.contains(e))return n;if(e.contains(n))return e;var t=new Range;return t.setStartBefore(n),t.setEndAfter(e),t.collapsed&&(t.setStartBefore(e),t.setEndAfter(n)),t.commonAncestorContainer}(c,l);return{root:a,list:o,head:c,tail:l,cover:r?a:i(t)}},y=function(n,t){var r=Array.isArray(t.node)?t.node.map((function(n){return e({},t,{node:n})})):t;return n.concat(r)},I=function(n,e){var t=n.reduce((function(n,t){var r,u=n[0],o=n[1],c=n[2],l=n[3],a=n[4],f=n[5],s=function(n){var e;return null===(e=t.type)||void 0===e?void 0:e.includes(n)};return null!=(r=t.node)&&e.contains(i(r))||null==r?(s("keydown")&&(u=u.concat(t)),s("click")&&(o=o.concat(t)),s("focus")&&(c=c.concat(t)),s("outlist")&&(f=f.concat(t))):(s("click")&&(l=l.concat(t)),s("focus")&&(a=a.concat(t)),s("outlist")&&(f=f.concat(t))),[u,o,c,l,a,f]}),new Array(6).fill([])),r=t[0],u=t[1],o=t[2],c=t[3],l=t[4],a=t[5];return{keyExits:r,clickExits:u,focusExits:o,hasClickExits:u.length>0,hasFocusExits:o.length>0,hasKeyExits:r.length>0,clickExits_wild:c,focusExits_wild:l,outListExits:a}},m=function(n,t,o,i,c){var l,f,s=[].concat(n).filter((function(n){return null!=n})).map((function(n){return r(n)?n:{node:n}})).map((function(n){return e({},n,{type:void 0===n.type?[null==n.key?"":"keydown",null==n.node?"":"click"].filter((function(n){return""!==n})):[].concat(n.type)})})).reduce(y,[]),v=u(t)?t:!0===t?null!==(l=null===(f=s[0])||void 0===f?void 0:f.on)&&void 0!==l?l:function(){}:t;return[u(v)?{node:null,key:a,on:v,target:o?i:c,type:["keydown"]}:null].concat(s).filter((function(n){return null!=n}))},g=function(n,e){var r=n?function(n,e){var r=u(n),o=r&&n(e),i=r&&"[object Promise]"===t(o)&&"function"==typeof o.then,c=r&&!i;return{promiseDelay:i,callbackDelay:c,commonDelay:!0===n&&!i&&!c,delayRes:o}}(n,e):{},o=r.promiseDelay,i=r.callbackDelay,c=r.commonDelay,l=r.delayRes;if(o)l.then(e);else if(i);else{if(!c)return!0;e()}},E=function(n,e,t,r,o,c,l,a){if(null==n||!0===n)return o?e:l;if(u(n)){var f=n({e:a,list:t,cover:e,root:r,last:t[c],lastI:c});return null==f||!0===f?o?e:l:f}return i(n)},k=function(){function n(){this.cache=[],this.isEmpty=!0}var e=n.prototype;return e.push=function(n,e,t){this.isEmpty=!1,this.cache.push({node:n,type:e,handler:t})},e.clean=function(){this.cache=[],this.isEmpty=!0},e.addListeners=function(){this.cache.forEach((function(n){var e;return null===(e=n.node)||void 0===e?void 0:e.addEventListener(n.type,n.handler)}))},e.removeListeners=function(){this.cache.forEach((function(n){var e;return null===(e=n.node)||void 0===e?void 0:e.removeEventListener(n.type,n.handler)})),this.clean()},n}(),x=function(){function n(){this.cache=new Map}var e=n.prototype;return e.has=function(n){return this.cache.has(n)},e.push=function(n,e,t){this.has(n)||(e.addEventListener("keydown",t),this.cache.set(n,{node:e,handler:t}))},e.remove=function(n){var e=this;[].concat(n).forEach((function(n){return e.cache.get(n).node.removeEventListener("keydown",e.cache.get(n).handler)}))},n}(),w=function(){function e(){this.data=[],this.head=null,this.tail=null,this.prevI=-1,this.curI=-1,this._prev=null,this._cur=null}var t,r,u,o=e.prototype;return o.update=function(n){this.data.splice(0,this.data.length),Array.prototype.push.apply(this.data,n),this.head=n[0],this.tail=n.at(-1)},o.isEmpty=function(){return 0===this.data.length},o.has=function(n){return!!this.data[n]},o.record=function(n,e){this.curI===e||this.curI<0&&e<0||(this.recordPrev(this.cur,this.curI),this.recordCur(n,e))},o.recordPrev=function(n,e){this.prevI=e<0?-1:e,this.prev=n||null},o.recordCur=function(n,e){this.curI=e<0?-1:e,this.cur=n||null},o.recordSequenceByIdx=function(n){this.record(this.data[n],n)},t=e,(r=[{key:"prev",get:function(){return this._prev||this.data[this.prevI]||null},set:function(n){this._prev=n}},{key:"cur",get:function(){return this._cur||this.data[this.curI]||null},set:function(n){this._cur=n}}])&&n(t.prototype,r),u&&n(t,u),Object.defineProperty(t,"prototype",{writable:!1}),e}();return function(){var n,t,f=0-((arguments.length<=0?void 0:arguments[0])instanceof Array),b=0+f<0||arguments.length<=0+f?void 0:arguments[0+f],L=1+f<0||arguments.length<=1+f?void 0:arguments[1+f],S=null!==(n=2+f<0||arguments.length<=2+f?void 0:arguments[2+f])&&void 0!==n?n:{};if(!(Array.isArray(L)&&L.length>1))throw new Error("请至少传入一个数组，数组至少包含两个可聚焦元素，用来表示列表的头和尾。");var D=S.sequence,j=S.loop,A=S.next,B=S.prev,P=S.trigger,T=S.entry,q=S.exit,C=S.onEscape,_=S.onClick,F=S.onMove,O=S.cover,M=S.initialActive,N=S.correctionTarget,K=S.delayToFocus,R=S.delayToBlur,J=S.removeListenersEachExit,z=void 0===J||J,G=S.removeListenersEachEnter,H=S.addEntryListenersEachExit,Q=void 0===H||H,U=S.manual,V=S.allowSafariToFocusAfterMousedown,W=void 0===V||V,X=[].concat(T).filter((function(n){return null!=n})).map((function(n){return r(n)?n:{node:n}})).map((function(n){var t;return e({},n,{delay:null!==(t=n.delay)&&void 0!==t?t:K,type:void 0===n.type?[null==n.key?"":"keydown",null==n.node?"":"click"].filter((function(n){return""!=n})):[].concat(n.type),onExit:!0===n.onExit?n.on:n.onExit})})).reduce(y,[]),Y=0===X.length,Z=new Set(X.map((function(n){return u(n.onExit)?n.node:null})).filter((function(n){return null!=n})).map((function(n){return i(n)}))),$=i(P||(null===(t=X[0])||void 0===t?void 0:t.node)),nn=r(O)?O:{},en=nn.node,tn=nn.enterKey,rn=nn.onEnter,un=nn.exit,on=null!=O&&!1!==O&&!1!==en,cn=on&&(!0===O||!0===en||null==en),ln=[].concat(un).filter((function(n){return null!=n})).map((function(n){return r(n)?n:{key:n}})).map((function(n){var t;return e({},n,{target:null!==(t=n.target)&&void 0!==t?t:$})})),an=on&&0===ln.length,fn=new w;fn.recordPrev(null,null!=M?M:-1);var sn=r(A)?A:{key:A},vn=sn.key,dn=sn.on,pn=r(B)?B:{key:B},hn=pn.key,yn=pn.on,In=!1===C,mn=!(null==j||j),gn=!!(vn||hn||D),En=!1,kn=!1,xn=new k,wn=new k,bn=new x;if(!U&&(qn(),(Y?[{}]:X).some((function(n){return!n.delay})))){var Ln=h(b,L,en,cn),Sn=Ln.root,Dn=Ln.list,jn=Ln.cover;fn.update(Dn),Tn(Sn,fn,jn)}var An={enter:function(n){if($=$||o(),n)return Bn({fromInvoke:!0},n.on,n.target,n.delay);for(var e=function(){var n=X[t],e=n.on,r=n.type,u=n.node,o=n.target,i=n.delay;if(null!=r&&r.some((function(n){return null==n||!1===n||"invoke"===n}))||null==u)return{v:Bn({fromInvoke:!0},e,o,i)}},t=0;t<X.length;++t){var r=e();if("object"==typeof r)return r.v}return Bn({fromInvoke:!0})},exit:function(n){var e=h(b,L,en,cn),t=e.list,r=e.cover,u=e.root;if(n){var o=n.on,c=n.target;return v(i(c),o)}for(var l=m(q,C,on,r,$),a=function(){var n=l[f],e=n.on,t=n.type,r=n.target;if(null!=t&&t.some((function(n){return null==n||!1===n||"invoke"===n})))return{v:v(r,e)}},f=0;f<l.length;++f){var s=a();if("object"==typeof s)return s.v}function v(n,e){return fn.isEmpty()&&fn.update(t),Pn({fromInvoke:!0},e,n,!1,r,fn.data,u)}},removeListeners:function(){xn.removeListeners(),wn.removeListeners()},removeListRelatedListeners:function(){xn.removeListeners()},removeEntryListeners:function(){wn.removeListeners()},addEntryListeners:function(){qn()},addListRelatedListeners:function(){var n=h(b,L,en,cn),e=n.root,t=n.list,r=n.cover;fn.isEmpty()&&fn.update(t),Tn(e,fn,r)},addForward:function(n,e){var t=null;if(u(e)){var r=h(b,L,en,cn);t=e({root:r.root,list:r.list,head:r.head,tail:r.tail,cover:r.cover,curI:fn.curI,prevI:fn.prevI})}else t=e;var o=t,c=o.node,l=o.on,a=o.key,f=o.target,s=i(c),v=i(f);bn.push(n,s,(function(n){null!=a&&a(n,fn.prevI,fn.curI)&&(n.preventDefault(),null==l||l(),p(v))}))},removeForward:function(n){bn.remove(n)},updateList:function(n){var e=n.map((function(n){return i(n)})).filter((function(n){return null!=n}));fn.update(e)},i:function(n){if(fn.has(n)&&En){fn.recordSequenceByIdx(n);var e=fn.prev,t=fn.prevI,r=fn.cur,u=fn.curI;return null==F||F({e:{fromI:!0},prev:e,prevI:t,cur:r,curI:u}),d(L[u]),n}return fn.curI<0?fn.prevI:fn.curI}};return An;function Bn(n,e,t,r){function u(){var e=h(b,L,en,cn),r=e.root,u=e.list,o=e.cover;fn.update(u),U||Tn(r,fn,o),!1!==t&&function(e,r,u){var o=r.data,i=r.prev,c=r.head,l=r.curI,a=i||c,f=E(t,e,o,u,on,l,a,n),s=o.indexOf(f);if(s>-1){if(gn){r.recordSequenceByIdx(s);var v=r.cur,d=r.curI;null==F||F({e:n,prev:null,cur:v,prevI:-1,curI:d})}En=!0}on&&(f===e||s>-1)&&(kn=!0);p(f)}(o,fn,r)}kn||En||Promise.resolve(null==e?void 0:e(n)).then((function(n){!r?u():g(r,u)}))}function Pn(n,e,t,r,o,i,c,l){var a;if(!En||u(l)&&!l({e:n,prev:fn.prev,cur:fn.cur,prevI:fn.prevI,curI:fn.curI}))return!1;fn.recordSequenceByIdx(-1),En=!1,null===(a=n.preventDefault)||void 0===a||a.call(n);var f=E(t,o,i,c,on,fn.curI,$,n);return f?function(){function t(){d(f),gn&&(null==F||F({e:n,prev:fn.prev,cur:null,prevI:fn.prevI,curI:-1})),U||(f!==o&&Cn(),Q&&qn())}Promise.resolve(null==e?void 0:e(n)).then((function(n){var e;r=null!==(e=r)&&void 0!==e?e:R,g(r,t)&&t()}))}():function(){function t(e){return function(t){e&&d(e),gn&&(null==F||F({e:n,prev:fn.prev,cur:null,prevI:fn.prevI,curI:-1})),U||(Cn(),Q&&qn())}}Promise.resolve(null==e?void 0:e(n)).then((function(e){if(!1!==f)if(on)gn&&(null==F||F({e:n,prev:fn.prev,cur:null,prevI:fn.prevI,curI:-1})),d(o);else{var u;r=null!==(u=r)&&void 0!==u?u:R;var i=t($);g(r,i)&&i()}else t()()}))}()}function Tn(n,e,t){var r=e.data,u=e.head,f=e.tail;if(xn.isEmpty){if(null==n)throw new Error("没有找到元素 "+b+"，您可以尝试 delayToFocus 选项，等待元素 "+b+" 渲染完毕后进行聚焦。");if(null==u||null==f)throw new Error("至少需要包含两个可以聚焦的元素，如果元素需要等待渲染，您可以尝试 delayToFocus 选项。");!function(){var u=function(){return!!Y||En},h=gn?function(n,e,t,r,u,o,i,c,l,a){return function(f){if(f.target!==c&&a()){var p=e(),h=p[0],y=p[1],I=Math.max(0,h),m=n.length;if((null!=r?r:s)(f)){var g=I+1,E=t?Math.min(m-1,g):g;E%=m,null==o||o({e:f,prev:n[I],cur:n[E],prevI:I,curI:E}),null==l||l({e:f,prev:n[I],cur:n[E],prevI:I,curI:E}),y(E),d(n[E]),f.preventDefault()}else if((null!=u?u:v)(f)){var k=I-1,x=t?Math.max(0,k):k;x=(x+m)%m,null==i||i({e:f,prev:n[I],cur:n[x],prevI:I,curI:x}),null==l||l({e:f,prev:n[I],cur:n[x],prevI:I,curI:x}),y(x),d(n[x]),f.preventDefault()}}}}(r,(function(){return[e.curI,e.recordSequenceByIdx.bind(e)]}),mn,vn,hn,dn,yn,t,F,u):function(n,e,t,r,u,o,i){return function(c){var l=n[0],a=n.at(-1),f=c.target;f!==o&&i()&&(s(c)?(null==t||t({e:c}),f===a&&(c.preventDefault(),e||d(l)),f===u&&(c.preventDefault(),d(l))):v(c)&&(null==r||r({e:c}),f===l&&(c.preventDefault(),e||d(a)),f===u&&(c.preventDefault(),d(a))))}}(r,mn,dn,yn,n,t,u),y=m(q,C,on,t,$),g=I(y,n),E=g.keyExits,k=g.clickExits,x=g.focusExits,w=g.hasClickExits,b=g.hasFocusExits,L=g.hasKeyExits,S=g.clickExits_wild,D=g.focusExits_wild,j=g.outListExits,A=S.map((function(n){return[i(null==n?void 0:n.node),z(n)]})),B=D.map((function(n){return[i(null==n?void 0:n.node),G(n)]}));xn.push(n,"focusin",(function(u){if(on&&u.target===t)return void(kn=!0);if(on&&!1===P&&!1===kn)return void p(t);if(!1!==N&&gn&&!1===En&&!1===P){var o,c=e.prev||e.head,l=null!==(o=null==N?void 0:N({list:r,cover:t,root:n,last:e.prev,lastI:e.prevI}))&&void 0!==o?o:c,a=i(l),f=r.findIndex((function(n){return n===a}));f>-1&&(e.recordSequenceByIdx(f),null==F||F({e:u,prev:null,cur:e.cur,prevI:-1,curI:e.curI})),En=!0,p(a)}En=!0})),xn.push(n,"focusout",(function(r){if(Z.has(r.relatedTarget))return;c((function(){var u=o(),i=!n.contains(u),c=u===t;if(r.target===t&&i)kn=!1;else{var l=null;(c||i)&&(l=O(r),e.recordSequenceByIdx(-1)),!1!==l&&(c?En=!1:i&&(En=!1,kn=!1))}}))})),n.contains(t)||null==t||(xn.push(t,"focus",(function(){kn=!0})),xn.push(t,"blur",(function(){T?T=!1:kn=!1})));xn.push(n,"keydown",(function(n){h(n),L&&function(n){if(n.target===t)return;if(In&&a(n))return;for(var e=0;e<E.length;++e){if(J(n,E[e]))break}}(n)})),(gn||w)&&xn.push(n,"click",(function(n){gn&&function(n){var t=r.findIndex((function(e){return e.contains(n.target)}));if(t>-1){var u=e.prev,o=e.prevI,i=e.curI;e.recordSequenceByIdx(t);var c=e.prev,l=e.prevI,a=e.cur,f=e.curI;i<0&&o!==t&&(c=u,l=o),null==_||_({e:n,prev:c,cur:a,prevI:l,curI:f}),i!==f&&(null==F||F({e:n,prev:c,cur:a,prevI:l,curI:f}))}}(n),w&&function(n){for(var e=0;e<k.length;++e){if(K(n,k[e]))break}}(n)}));xn.push(n,"mousedown",(function(n){var e;P=!0,c((function(){return P=!1})),(!gn||gn&&(e=r.find((function(e){return e.contains(n.target)}))))&&(En=!0,on&&(kn=!0),W&&e&&void 0!==window.safari&&(d(e),n.preventDefault()))})),b&&xn.push(n,"focusin",(function(n){for(var e=0;e<x.length;++e){if(R(n,x[e]))break}}));B.forEach((function(n){var e=n[0],t=n[1];xn.push(e,"focus",t)})),A.forEach((function(n){var e=n[0],t=n[1];xn.push(e,"click",t)})),null!=t&&xn.push(t,"keydown",(function(n){if(n.target!==t)return;if(!kn||En)return;if((null!=tn?tn:l)(n)&&!En)return n.preventDefault(),T=!0,En=!0,null==rn||rn(n),void(gn?(e.recordSequenceByIdx(Math.max(0,e.prevI)),d(e.cur),null==F||F({e:n,prev:null,cur:e.cur,prevI:-1,curI:e.curI})):d(e.data[0]));for(var r=0;r<ln.length;++r){var u=ln[r],o=u.key,c=u.on,a=u.target,v=i(a);if(null!=o&&o(n,e.prevI,e.curI))return void p(n,c,v)}if(an&&s(n))return void d(f);function p(n,e,t){null==e||e(n),t&&d(t),Cn()}}));xn.addListeners();var P=!1,T=!1;function O(e){for(var u=0;u<j.length;++u){var o=j[u],c=o.on,l=o.target,a=o.delay;return Pn(e,c,i(l),a,t,r,n,j[u].if)}}function M(e,u,o){var c=u.node,l=u.on,a=u.target,f=u.delay,s=i(c),v=i(a);return!o(e,s,u.key)&&(Pn(e,l,v,f,t,r,n,u.if),!0)}function K(n,e){return M(n,e,(function(n,e){return null!=e&&!e.contains(n.target)||null==e}))}function R(n,e){return M(n,e,(function(n,e){return null!=e&&n.target!==e||null==e}))}function J(n,t){return M(n,t,(function(n,t,r){return null!=t&&n.target!==t||!(null!=r&&r(n,e.prevI,e.curI))}))}function z(n){return function(e){K(e,n)}}function G(n){return function(e){R(e,n)}}}()}}function qn(){if(wn.isEmpty){for(var n=function(){var n=X[e],t=n.node,r=n.on,o=n.key,c=n.type,l=n.target,a=n.delay,f=n.onExit,s=n.if,v=[].concat(c),d=["keydown","focus","click"],p=i(t);v.forEach((function(n){if(p&&d.includes(n)){var e="keydown"===n,t=e?function(n){return null==o?void 0:o(n,fn.prevI,fn.curI)}:function(n){return!0};wn.push(p,n,function(n,e){return function(t){u(s)&&!s({e:t,prev:fn.prev,cur:fn.cur,prevI:fn.prevI,curI:fn.curI})||!n(t)||function(n,e){var t=0;if(En){if(u(f)){var o=h(b,L,en,cn),i=o.list,c=o.cover,s=o.root;Pn(n,f,l,!1,c,i,s),t=!t}}else Bn(n,r,l,a),G&&!U&&wn.removeListeners(),t=!t;e&&t&&n.preventDefault()}(t,e)}}(t,e))}}))},e=0;e<X.length;++e)n();wn.addListeners()}}function Cn(){an||z&&!U&&xn.removeListeners()}}}));
//# sourceMappingURL=focus-no-jutsu.umd.min.js.map
